#!/usr/bin/env python

import os
import sys

sys.path.insert(
    0,
    os.path.abspath(
        os.path.join(os.path.dirname(__file__), '..', 'lib', 'benchlib')
    )
)

from opster import command, dispatch
from schema import Schema

@command()
def install(
        schema_name,
        interactive=('i', False, 'drop into the shell when source will be ready')
    ):
    osbench_root = os.path.dirname(os.path.dirname(__file__))
    schemas = os.path.join(osbench_root, 'schemas')

    if sys.path[0] != schemas:
        filename = os.path.join(schemas, schema_name + '.py')
        code = compile(open(filename).read(), filename, 'exec')

        locals = {}
        eval(code, globals(), locals)

        schemas = [schema for schema in locals.values() if isinstance(schema, type) and issubclass(schema, Schema)]
        assert len(schemas) == 1

        env = dict(
            osbench_root=osbench_root,
            schema=schema_name,
            schema_filename=filename,
        )
        schema = schemas[0](env)
        schema._install(interactive=interactive)


if __name__ == '__main__':
    dispatch()

