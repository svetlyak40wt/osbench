#!/usr/bin/env python

import sys
import tempfile
import os
import re
import subprocess


class Schema(object):
    url = None
    homepage = None
    deps = []

    def __init__(self, env):
        self.env = env.copy()
        version = re.search(r'(\d+\.\d+\.\d+)', self.url).group(1)
        self.env['prefix'] = os.path.join(
            env['diy_prefix'],
            'workbench',
            '%s-%s' % (env['schema'], version)
        )

    def _get_source(self):
        subprocess.call('wget "{0}"'.format(self.url), shell=True)
        files = os.listdir('.')
        assert len(files) == 1

        subprocess.call('tar -jxvf "{0}"'.format(files[0]), shell=True)
        os.unlink(files[0])

        dirs = os.listdir('.')
        assert len(dirs) == 1

        os.chdir(dirs[0])

    def _install_deps(self):
        if self.deps:
            print 'installing dependencies'
            for dep in self.deps:
                self.call('sudo apt-get install %s' % dep)

    def _install(self):
        print 'base install'

        self._install_deps()

        root = tempfile.mkdtemp(prefix='diy-')
        try:
            os.chdir(root)

            self._get_source()

            self.install()

            self._symlink()

        finally:
            subprocess.call('rm -fr "{0}"'.format(root), shell=True)

    def _symlink(self):
        for dir_name in ['bin', 'sbin', 'etc', 'lib', 'include']:
            s_dir = os.path.join(self.env['prefix'], dir_name)
            t_dir = os.path.join(self.env['diy_prefix'], dir_name)
            if os.path.exists(s_dir) and os.path.exists(t_dir):
                for filename in os.listdir(s_dir):
                    os.symlink(
                        os.path.join(s_dir, filename),
                        os.path.join(t_dir, filename)
                    )

    def call(self, command):
        subprocess.call(command.format(**self.env), shell=True)


def install(schema_name):
    diy_prefix = os.path.dirname(os.path.dirname(__file__))
    schemas = os.path.join(diy_prefix, 'schemas')

    if sys.path[0] != schemas:
        filename = os.path.join(schemas, schema_name + '.py')
        code = compile(open(filename).read(), filename, 'exec')

        locals = {}
        module = eval(code, globals(), locals)

        schemas = [schema for schema in locals.values() if issubclass(schema, Schema)]
        assert len(schemas) == 1

        env = dict(
            diy_prefix=diy_prefix,
            schema=schema_name,
        )
        schema = schemas[0](env)
        schema._install()


def main():
    install('collectd')


if __name__ == '__main__':
    main()

